# Markdown見出しレベルの自動調整

## 概要

**Markdown見出しレベルの自動調整**機能は、ドキュメント構造における実際のアウトライン深度に基づいて、Markdown見出しレベル（`#`〜`######`）を自動的に正規化します。これにより、ノート全体で一貫した見出し階層を維持できます。

## 主な機能

- **自動レベル正規化**: ドキュメント階層における位置に合わせて、Markdown見出しレベルを書き換えます
- **プリセット設定**: 3つの事前定義された見出しレベル範囲から選択可能
- **H1予約オプション**: ページタイトル用にH1を予約するオプション
- **ソース書き換え**: 永続的な変更のためにMarkdownソースを直接変更
- **既存機能との互換性**: 既存の見出し番号付け機能と並行して動作

## 設定

### 機能の有効化

1. プラグイン設定を開く
2. 「ページアウトライン機能」セクションに移動
3. 「見出しレベルの自動調整を有効にする」を有効化

### 見出しレベル範囲プリセット

見出し正規化のために、3つのプリセット範囲から1つを選択します：

#### H2〜H6（デフォルト）
- 第1レベルの見出し → H2
- 第2レベルの見出し → H3
- 第3レベルの見出し → H4
- 第4レベルの見出し → H5
- 第5レベル以降の見出し → H6

**使用例**: ページタイトルにH1を予約し、コンテンツ構造にH2〜H6を使用

#### H1〜H3
- 第1レベルの見出し → H1
- 第2レベルの見出し → H2
- 第3レベル以降の見出し → H3

**使用例**: 階層深度が限られたシンプルなドキュメント

#### H2〜H4
- 第1レベルの見出し → H2
- 第2レベルの見出し → H3
- 第3レベル以降の見出し → H4

**使用例**: タイトル用にH1を予約した中程度の階層

### H1をページタイトル用に予約

有効にすると、このオプションは既存のH1見出しを保持し、正規化中に新しいH1見出しが作成されるのを防ぎます。

**動作:**
- **既存のH1見出し**: そのまま保持され、変更されません
- **H1になる予定の新しい見出し**: 代わりにH2に昇格されます

このオプションはすべてのプリセットで機能します：
- **H2-H6またはH2-H4プリセット**: ドキュメントに存在する可能性のある既存のH1見出しを保持します
- **H1-H3プリセット**: さらに、深度1の見出しがH1になるのを防ぎ、H2に昇格します

これは、各ページに1つのH1（タイトル）のみを持つべきというセマンティックHTML構造を維持するのに便利です。そのH1は手動で配置され、自動正規化によって変更されるべきではありません。

## 使用方法

### コマンド

コマンドパレットから2つのコマンドが利用可能です：

1. **現在のページの見出しを正規化**
   - 現在開いているページのすべての見出しを正規化
   - キーボードショートカット: コマンドパレット経由でアクセス

2. **選択範囲の見出しを正規化**
   - 選択したブロックとその子ブロックの見出しを正規化
   - キーボードショートカット: コマンドパレット経由でアクセス

### アルゴリズム

正規化は次の式を使用します：

```
level = clamp(minLevel + depth - 1, minLevel, maxLevel)
```

ここで：
- `depth` = アウトライン階層における見出しの位置（1, 2, 3, ...）
- `minLevel` = プリセットからの最小見出しレベル（例：H2〜H6の場合は2）
- `maxLevel` = プリセットからの最大見出しレベル（例：H2〜H6の場合は6）

### 例

**H2〜H6プリセット:**
- 深度1 → H2
- 深度2 → H3
- 深度3 → H4
- 深度4 → H5
- 深度5以降 → H6

**H1〜H3プリセット:**
- 深度1 → H1
- 深度2 → H2
- 深度3以降 → H3

## 互換性

### 既存の見出し番号付け機能との互換性

見出しレベル自動調整機能は、既存の階層的見出し番号付け機能と並行して動作するように設計されています：

1. **処理順序**: 見出しレベル正規化 → 見出し番号付け → 目次生成
2. **独立した操作**: 両方の機能を同時に有効化可能
3. **競合なし**: 番号付けはレベル正規化の後に適用されます
4. **自動統合**: 両方の機能を有効にすると、ページ読み込み時に見出しレベルが自動的に正規化された後、番号が適用されます

#### 自動統合

「見出しレベルの自動調整」と「見出し番号付け（ファイル更新モード）」の両方を有効にした場合：

- **ページ読み込み時**: 見出しレベルが最初に自動的に正規化され、その後階層番号が適用されます
- **手動操作不要**: 正規化はバックグラウンドで静かに実行されます
- **一貫した階層**: 見出しレベルと番号付けの両方が正しいドキュメント構造を反映することを保証します

この統合により、見出し番号が常に適切にレベル付けされた見出しに適用され、セマンティックな正確性を維持します。

### 目次とアンカーとの互換性

見出しレベルを正規化した後、目次とアンカーリンクは新しい構造を反映するために自動的に再生成されます。

## 重要な注意事項

### 初期状態

この機能は、既存のユーザーの動作を保持するために**デフォルトで無効**になっています。設定で明示的に有効化する必要があります。

### ファイルベース版のみ

この機能は、ファイルベース（ローカル）のLogseqグラフでのみ動作します。クラウドベースのグラフでは使用できません。

### バックアップの推奨

この機能はMarkdownソースファイルを変更するため、以下を推奨します：
- 一括正規化の前にバージョン管理に作業をコミットする
- まず1つのページでテストする
- 大規模な正規化を進める前に変更を確認する

### 非見出し要素

以下の要素は見出し正規化の影響を**受けません**：
- 段落
- コードブロック
- 引用
- リスト
- ページプロパティ
- タグ

Markdown見出し（`#`〜`######`で始まる行）のみが処理されます。

## トラブルシューティング

### 見出しが変更されない

1. 設定で機能が有効になっていることを確認
2. ファイルベースのグラフを使用していることを確認
3. ブロックに有効なMarkdown見出しが含まれていることを確認
4. 見出しがすでに正しいレベルになっていないか確認

### 予期しない見出しレベル

1. 選択したプリセット設定を確認
2. 「H1をページタイトル用に予約」オプションを確認
3. ドキュメント内の見出し階層を確認
4. 注意: 最大レベルを超える深度はmaxLevelにクランプされます

### コマンドが見つからない

コマンドパレットからコマンドにアクセスする前に、プラグインが完全にロードされていることを確認してください。
